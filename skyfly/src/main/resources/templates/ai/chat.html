<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="es"
      layout:decorate="~{layouts/_MainLayout}">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Travel Copilot</title>

  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --line: #e5e7eb;
      --primary: #2563eb;
      --primary-600: #1d4ed8;
      --radius: 16px;
    }

    .wrap {
      max-width: 1200px;
      margin: 28px auto;
      padding: 0 16px
    }

    .layout {
      display: grid;
      gap: 18px;
      grid-template-columns: 1fr
    }

    @media (min-width:980px) {
      .layout {
        grid-template-columns: 480px 1fr
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(2, 6, 23, .08)
    }

    .card__body {
      padding: 18px
    }

    .grid {
      display: grid;
      gap: 12px
    }

    .g2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .g3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    @media(max-width:680px) {

      .g2,
      .g3 {
        grid-template-columns: 1fr
      }
    }

    label {
      font-size: .92rem;
      color: #4b5563;
      margin: 0 0 6px;
      display: block
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      outline: none
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, .12)
    }

    .checks {
      display: flex;
      flex-wrap: wrap;
      gap: 16px
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    button {
      padding: 12px 16px;
      border: 0;
      border-radius: 12px;
      color: #fff;
      background: var(--primary);
      cursor: pointer;
      font-weight: 600;
      letter-spacing: .2px
    }

    button:hover {
      background: var(--primary-600)
    }

    button[disabled] {
      opacity: .7;
      cursor: wait
    }

    pre {
      white-space: pre-wrap;
      margin: 0;
      padding: 14px;
      min-height: 160px;
      max-height: 560px;
      overflow: auto;
      border: 1px dashed var(--line);
      border-radius: 12px;
      background: #fafbfe;
      font-family: ui-monospace, Consolas, Menlo, monospace
    }

    .header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      background: #eef2ff;
      color: #1d4ed8;
      border: 1px solid #dbeafe;
      text-decoration: none;
      font-weight: 600
    }

    .pill:hover {
      background: #e0e7ff
    }

    .muted {
      color: #6b7280
    }

    .spin {
      display: inline-block;
      width: 1em;
      height: 1em;
      border: .18em solid rgba(255, 255, 255, .45);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .8s linear infinite;
      vertical-align: -.2em;
      margin-right: .5em
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    /* Tarjetas */
    .cards {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 14px
    }

    @media (min-width:720px) {
      .cards {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }
    }

    @media (min-width:1100px) {
      .cards {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }
    }

    .dest-card {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 10px 30px rgba(2, 6, 23, .06);
      overflow: hidden;
      display: flex;
      flex-direction: column
    }

    .dest-img {
      position: relative;
      aspect-ratio: 16/9;
      overflow: hidden
    }

    .dest-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #fff;
      color: #111;
      font-weight: 800;
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .15);
      border: 1px solid #e5e7eb
    }

    .dest-body {
      padding: 16px;
      display: grid;
      gap: 8px
    }

    .dest-title {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 800
    }

    .dest-sub {
      margin: 0;
      color: #6b7280
    }

    .btn-sm {
      display: inline-block;
      text-decoration: none;
      background: var(--primary);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 10px 20px rgba(37, 99, 235, .18)
    }

    .btn-sm:hover {
      background: var(--primary-600)
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px
    }

    .chip {
      font-size: .85rem;
      color: #1f2937;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 6px 10px;
      border-radius: 999px
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <main class="wrap">
    <div class="header">
      <div>
        <h1 style="margin:0 0 6px">Sky Bot</h1>
        <p class="muted" style="margin:0">No sabes a dónde viajar, busca tu destino favorito.</p>
      </div>
      <a th:href="@{/cliente/destinos}" class="pill">Explorar destinos</a>
    </div>

    <section class="layout">
      <!-- ===== FORM ===== -->
      <div class="card">
        <div class="card__body">
          <form id="chat" onsubmit="sendAI(event)">
            <div class="grid g2">
              <div>
                <label for="origen">Origen Aeropuerto</label>
                <input id="origen" list="airports" maxlength="3" pattern="[A-Za-z]{3}"
                       oninput="this.value=this.value.toUpperCase()" placeholder="Ej: SAL" required>
                <datalist id="airports">
                  <option value="SAL">San Salvador — El Salvador Intl</option>
                  <option value="MEX">Ciudad de México — MEX</option>
                  <option value="GUA">Guatemala — La Aurora</option>
                  <option value="LAX">Los Ángeles — LAX</option>
                  <option value="MIA">Miami — MIA</option>
                  <option value="MAD">Madrid — Barajas</option>
                </datalist>
              </div>
            </div>

            <div class="grid g3" style="margin-top:10px">
              <div>
                <label for="dias">Días</label>
                <input id="dias" type="number" value="7" min="1" required />
              </div>
              <div>
                <label for="presuMin">Presupuesto mínimo</label>
                <input id="presuMin" type="number" value="800" min="50" required />
              </div>
              <div>
                <label for="presuMax">Presupuesto máximo</label>
                <input id="presuMax" type="number" value="1500" min="50" required />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Tipo de viaje</label>
              <div class="checks">
                <label><input type="checkbox" name="tipo" value="playa" checked> playa</label>
                <label><input type="checkbox" name="tipo" value="cultura"> cultura</label>
                <label><input type="checkbox" name="tipo" value="naturaleza"> naturaleza</label>
                <label><input type="checkbox" name="tipo" value="vida nocturna"> vida nocturna</label>
                <label><input type="checkbox" name="tipo" value="gastronomía"> gastronomía</label>
              </div>
            </div>

            <div class="grid g2" style="margin-top:10px">
              <div>
                <label for="companeros">Compañía</label>
                <select id="companeros">
                  <option>solo</option>
                  <option selected>pareja</option>
                  <option>familia</option>
                  <option>amigos</option>
                </select>
              </div>
              <div>
                <label for="nota">Notas (opcional)</label>
                <input id="nota" placeholder="Evitar escalas, celebrar aniversario, etc." />
              </div>
            </div>

            <div class="row" style="margin-top:14px">
              <button id="btn" type="submit">Buscar recomendaciones</button>
              <span id="hint" class="muted"></span>
            </div>
          </form>
        </div>
      </div>

      <!-- ===== RESULTADOS ===== -->
      <div class="card">
        <div class="card__body">
          <h3 class="card__title" style="margin:0 0 6px">Resultados</h3>
          <p class="muted" style="margin:0 0 10px">
            Los datos no se guardan; se usan sólo para esta recomendación.
          </p>

          <div id="cards" class="cards"></div>
          <pre id="out">(listo para recomendar… completa el brief y pulsa el botón)</pre>
        </div>
      </div>
    </section>
  </main>

  <script th:inline="javascript">
    // Endpoints correctos
    const API_URL_JSON = /*[[@{/api/ai/destinos/json}]]*/ '/api/ai/destinos/json';
    const API_URL_TEXT = /*[[@{/api/ai/destinos/text}]]*/ '/api/ai/destinos/text';

    // === Base de la app (incluye context path) ===
    const APP_CTX = /*[[@{/}]]*/ '/';

    // ===== Persistencia de formulario =====
    (function persistPrefs() {
      const ids = ['origen','dias','presuMin','presuMax','companeros','nota'];

      document.addEventListener('DOMContentLoaded', () => {
        ids.forEach(id => {
          const el = document.getElementById(id);
          const v = localStorage.getItem('tc_'+id);
          if (el && v !== null) el.value = v;
        });
        document.querySelectorAll('input[name="tipo"]').forEach(ch => {
          const v = localStorage.getItem('tc_tipo_'+ch.value);
          if (v !== null) ch.checked = (v === '1');
        });
      });

      document.addEventListener('input', (e) => {
        const t = e.target;
        if (ids.includes(t.id)) localStorage.setItem('tc_'+t.id, t.value);
        if (t.name === 'tipo') localStorage.setItem('tc_tipo_'+t.value, t.checked ? '1' : '0');
      });
    })();

    // ===== Payload =====
    function collectBody(){
      const tipo = [...document.querySelectorAll('input[name="tipo"]:checked')].map(i => {
        const v = i.value.trim().toLowerCase();
        // normalizamos "vida nocturna" -> "vidaNocturna"
        return (v.replace(/\s+/g,'') === 'vidanocturna') ? 'vidaNocturna' : i.value;
      });
      return {
        origenIATA: document.getElementById('origen').value.trim(),
        duracionDias: Number(document.getElementById('dias').value),
        presupuestoMinUSD: Number(document.getElementById('presuMin').value),
        presupuestoMaxUSD: Number(document.getElementById('presuMax').value),
        tipo,
        companeros: document.getElementById('companeros').value,
        notas: document.getElementById('nota').value.trim()
      };
    }

    // ===== Helpers =====
    const money = new Intl.NumberFormat('es-SV', { style:'currency', currency:'USD' });
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
    const norm = s => String(s||'')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/\s+/g,'');

    function guessImage(tags = []){
      const t = tags.map(x => (x||'').toLowerCase());
      let q = 'travel';
      if (t.some(s => s.includes('playa'))) q = 'beach';
      else if (t.some(s => s.includes('natur'))) q = 'forest';
      else if (t.some(s => s.includes('vida') && s.includes('noct'))) q = 'night city';
      else if (t.some(s => s.includes('gastron'))) q = 'food market';
      else if (t.some(s => s.includes('cultur'))) q = 'historic city';
      return `https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=60&sig=${encodeURIComponent(q)}`;
    }

    // Fallback (texto plano) -> items (por si quieres usar /text alguna vez)
    function parseNumber(s){
      if (!s) return 0;
      const clean = s.replace(/\s/g,'')
                     .replace(/(\.|,)(?=[0-9]{3}\b)/g,'')
                     .replace(',', '.');
      const n = Number(clean);
      return isFinite(n) ? n : 0;
    }

    function parseFallback(text){
      const items = [];
      if (!text) return items;
      const lineRe = /^\d+\)\s*(.+?)\s*(?:—|–|-)\s*(.+?)\s*(?:—|–|-)\s*costo\s*~?\s*USD\s*([0-9][0-9\.,]*)/i;
      const lines = String(text).split('\n');
      let current = null;
      for (const raw of lines){
        const line = raw.trim();
        const m = line.match(lineRe);
        if (m){
          const precio = parseNumber(m[3]);
          current = { nombre: m[1].trim(), pais: m[2].trim(), precio, tags: [] };
          items.push(current);
          continue;
        }
        const t = line.match(/Coincidenc(?:ia|ias)\s*:\s*\[([^\]]*)\]/i);
        if (t && current){
          current.tags = t[1].split(',').map(s => s.trim()).filter(Boolean);
        }
      }
      return items;
    }

    // Filtrado robusto (si algo falla, no filtramos)
    function applyClientFilter(items, requiredTags){
      try{
        const req = (requiredTags||[]).map(norm).filter(Boolean);
        if (!req.length) return items;
        return items.filter(it => {
          const tags = (it.tags||[]).map(norm);
          if (!tags.length) return true; // no descartar si no hay tags
          return tags.some(t => req.includes(t));
        });
      }catch{
        return items;
      }
    }

    // ===== URLs de imágenes =====
    function isAbsoluteUrl(u){
      return /^https?:\/\//i.test(u) || /^data:/i.test(u) || /^\/\//.test(u);
    }

    // Convierte a URL absoluta respetando el context path
    function toAbsolute(u){
      if (!u) return u;
      if (isAbsoluteUrl(u)) return u;

      const base = window.location.origin + (APP_CTX.endsWith('/') ? APP_CTX : APP_CTX + '/');
      if (u.startsWith('/')) u = u.slice(1);
      return base + u;
    }

    function pickImage(it){
      if (!it) return null;

      const raw =
        it.imagen || it.imageUrl || it.imagenUrl || it.urlImagen ||
        it.fotoPortada || it.foto || it.rutaImagen || it.pathImagen;

      let r = raw ? String(raw).trim() : null;

      if (!r && it.id != null){
        r = `/media/destinos/${it.id}`;
      }
      if (!r) return null;

      // "media/..." o "uploads/..." relativos
      if (/^(media|uploads)\//i.test(r)) {
        return toAbsolute(r);
      }
      if (r.startsWith('/')) {
        return toAbsolute(r);
      }
      return toAbsolute(r);
    }

    // ===== Render =====
    function renderCards(items, requiredTags){
      const wrap = document.getElementById('cards');
      const pre  = document.getElementById('out');

      const safeItems = Array.isArray(items) ? items : [];
      const filteredList = applyClientFilter(safeItems, requiredTags);

      if (!filteredList.length){
        wrap.innerHTML = '';
        pre.style.display = 'block';
        pre.textContent = '(sin coincidencias con los filtros)';
        return;
      }

      try {
        console.debug('[Copilot] render', filteredList.map(x => ({
          id: x.id, img: x.imagen, tags: x.tags
        })));
      } catch {}

      wrap.innerHTML = filteredList.map(it => {
        const img = pickImage(it) || guessImage(it.tags);
        return `
          <article class="dest-card">
            <div class="dest-img">
              <img loading="lazy"
                   src="${esc(img)}"
                   alt="${esc(it.nombre)}"
                   onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=60';">
              <span class="badge">Desde ${money.format(it.precio || 0)}</span>
            </div>
            <div class="dest-body">
              <h4 class="dest-title">${esc(it.nombre)}</h4>
              <p class="dest-sub">${esc(it.pais||'')}</p>
              <a href="/cliente/destinos" class="btn-sm">Reservar destino</a>
              <div class="chips">
                ${(it.tags||[]).map(t => `<span class="chip">${esc(t)}</span>`).join('')}
              </div>
            </div>
          </article>`;
      }).join('');

      pre.style.display = 'none';
    }

    // ===== Acción principal =====
    async function sendAI(e) {
      e.preventDefault();

      const btn  = document.getElementById('btn');
      const out  = document.getElementById('out');
      const wrap = document.getElementById('cards');

      const payload = collectBody(); // usa tus ids reales

      btn.disabled = true;
      btn.innerHTML = '<span class="spin"></span>Buscando...';

      out.style.display = 'block';
      out.textContent   = 'Consultando recomendaciones...';
      wrap.innerHTML    = '';

      try {
        const res = await fetch(API_URL_JSON, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const bodyText = await res.text();
        if (!res.ok) {
          throw new Error(bodyText || ('HTTP ' + res.status));
        }

        let json;
        try {
          json = JSON.parse(bodyText);
        } catch {
          throw new Error('Respuesta JSON inválida desde el backend.');
        }

        let items = json?.items;
        if (!Array.isArray(items)) {
          if (Array.isArray(json)) items = json;
          else items = [];
        }

        // Safety extra: si imagen viene null pero hay id
        items = items.map(it => ({
          ...it,
          imagen: (it.imagen && it.imagen.trim)
            ? it.imagen.trim()
            : (it.id != null ? (`/media/destinos/${it.id}`) : null)
        }));

        renderCards(items, payload.tipo);

      } catch (err) {
        console.error('Error llamando a /api/ai/destinos/json', err);
        out.style.display = 'block';
        out.textContent   = 'Error al obtener recomendaciones: ' + err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Buscar recomendaciones';
      }
    }
  </script>
</div>
</body>
</html>
