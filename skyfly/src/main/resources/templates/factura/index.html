<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="es"
      layout:decorate="~{layouts/_MainLayout}">
<head>
  <meta charset="UTF-8">
  <title>Facturas</title>
  <style>
    /* Micro-tweaks sin invadir tu layout global */
    .page-header { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    .kpi-chip { font-size:.875rem; padding:.35rem .6rem; border-radius:999px; background:#f1f5f9; }
    .actions a { margin-right:.25rem; }
    .table thead th { white-space:nowrap; }
    .empty-state { text-align:center; padding:3rem 1rem; color:#64748b; }
    .searchbar { max-width:420px; }
    .money { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body>
<section layout:fragment="content">

  <!-- Toast de éxito -->
  <div th:if="${msg != null}">
    <script>
      (function() {
        var text = /*[[${msg}]]*/ '';
        if (window.swal) {
          swal({ title: "Confirmación", text: text, icon: "success" });
        } else { alert("✔ " + text); }
      })();
    </script>
  </div>

  <!-- Toast de error -->
  <div th:if="${error != null}">
    <script>
      (function() {
        var text = /*[[${error}]]*/ '';
        if (window.swal) {
          swal({ title: "Error", text: text, icon: "error" });
        } else { alert("⚠ " + text); }
      })();
    </script>
  </div>

  <div class="container mt-4">
    <!-- Header -->
    <div class="page-header mb-3">
      <div>
        <h1 class="h3 m-0">Facturas</h1>
        <small class="text-muted">Gestión de comprobantes y descarga en PDF</small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="kpi-chip">
          Total: <span th:text="${#lists.size(facturas)}">0</span>
        </span>
        <!-- Buscador client-side -->
        <input id="facturaSearch" class="form-control form-control-sm searchbar" type="search"
               placeholder="Filtrar por #, fecha o reserva…">
      </div>
    </div>

    <!-- Empty state -->
    <div class="empty-state" th:if="${#lists.isEmpty(facturas)}">
      <h5 class="mb-1">No hay facturas todavía</h5>
      <p class="mb-3">Aprueba un pago o inserta una fila de prueba en la tabla <code>factura</code>.</p>
    </div>

    <!-- Tabla -->
    <div class="card" th:if="${!#lists.isEmpty(facturas)}">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped align-middle m-0" id="facturasTable">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Fecha</th>
                <th>Reserva</th>
                <th class="text-end">Monto</th>
                <th class="text-end">Impuestos</th>
                <th class="text-end">Total</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="f : ${facturas}">
                <td>
                  <span class="badge bg-secondary" th:text="${f.idFactura}">1</span>
                </td>
                <td th:text="${f.fechaEmision != null ? #temporals.format(f.fechaEmision,'dd/MM/yyyy') : 'N/D'}">01/01/2025</td>
                <td>
                  <span class="badge bg-light text-dark" th:text="${f.reserva != null ? f.reserva.reservaId : 'N/D'}">100</span>
                </td>
                <td class="text-end money" th:text="${f.montoTotal != null ? #numbers.formatDecimal(f.montoTotal,1,2) : '0.00'}">0.00</td>
                <td class="text-end money" th:text="${f.impuestos != null ? #numbers.formatDecimal(f.impuestos,1,2) : '0.00'}">0.00</td>
                <!-- Propiedad correcta: totalAPagar (getTotalAPagar()) -->
                <td class="text-end money"
                    th:text="${f.totalAPagar != null
                              ? #numbers.formatDecimal(f.totalAPagar,1,2)
                              : (f.montoTotal!=null && f.impuestos!=null
                                  ? #numbers.formatDecimal(f.montoTotal.add(f.impuestos),1,2)
                                  : '0.00')}">0.00</td>
                <td class="text-center actions">
                  <a class="btn btn-sm btn-outline-primary" th:href="@{|/facturas/${f.idFactura}|}">
                    Ver
                  </a>
                  <a class="btn btn-sm btn-primary" th:href="@{|/facturas/${f.idFactura}/pdf|}">
                    PDF
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div> <!-- /table-responsive -->
      </div>
    </div>
  </div>

  <!-- Filtro simple en cliente -->
  <script>
    (function(){
      const input = document.getElementById('facturaSearch');
      const table = document.getElementById('facturasTable');
      if (!input || !table) return;

      input.addEventListener('input', function(){
        const q = this.value.toLowerCase().trim();
        Array.from(table.tBodies[0].rows).forEach(tr => {
          const text = tr.innerText.toLowerCase();
          tr.style.display = text.includes(q) ? '' : 'none';
        });
      });
    })();
  </script>

</section>
</body>
</html>
